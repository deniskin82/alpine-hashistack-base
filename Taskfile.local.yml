version: '3'

dotenv: ['./taskfiles/files/base.cfg']
vars:
  VAULT_REPO: '../vault/local'
  BIN_DIR: '~/bin'

tasks:
  default:
    cmds:
      - task: download-iso
      - task: download-tools
      - task: generate-keys

  download-iso:
    cmds:
      - task: make-dir
        vars:
          DIR: http/iso
      - task: download-pkg
        vars: {
          SRC: "https://dl-cdn.alpinelinux.org/alpine/v${ALPINE_VERSION}/releases/x86_64/alpine-standard-${ALPINE_RELEASE}-x86_64.iso",
          DST: "http/iso/alpine-standard-${ALPINE_RELEASE}-x86_64.iso"
        }
      - task: download-pkg
        vars: {
          SRC: "https://dl-cdn.alpinelinux.org/alpine/v${ALPINE_VERSION}/releases/x86_64/alpine-standard-${ALPINE_RELEASE}-x86_64.iso.sha256",
          DST: "http/iso/alpine-standard-${ALPINE_RELEASE}-x86_64.iso.sha256"
        }
      - task: download-pkg
        vars: {
          SRC: "https://dl-cdn.alpinelinux.org/alpine/v${ALPINE_VERSION}/releases/x86_64/alpine-standard-${ALPINE_RELEASE}-x86_64.iso.asc",
          DST: "http/iso/alpine-standard-${ALPINE_RELEASE}-x86_64.iso.asc"
        }
  download-tools:
    cmds:
      - task: make-tools
      - task: download-nomad
      - task: download-consul
      - task: download-vault
      - task: download-gotask
  generate-keys:
    cmds:
      - task: make-encrypt
      - task: generate-nomad-key
      - task: generate-consul-key
  make-encrypt:
    cmds:
      - task: make-dir
        vars:
          DIR: http/vault
  make-tools:
    cmds:
      - task: make-dir
        vars:
          DIR: http/tools
  generate-nomad-key:
    cmds:
      - cp {{.VAULT_REPO}}/encrypt/nomad.key http/vault/nomad.key
    status:
      - test -f {{.VAULT_REPO}}/encrypt/nomad.key
      - test ! -f http/vault/nomad.key
  generate-consul-key:
    cmds:
      - cp {{.VAULT_REPO}}/encrypt/consul.key http/vault/consul.key
    status:
      - test -f {{.VAULT_REPO}}/encrypt/consul.key
      - test ! -f http/vault/consul.key
  download-nomad:
    cmds:
      - task: download-pkg
        vars: {
          SRC: "https://releases.hashicorp.com/nomad/${NOMAD_VERSION}/nomad_${NOMAD_VERSION}_linux_amd64.zip",
          DST: "http/tools/nomad_${NOMAD_VERSION}_linux_amd64.zip"
        }
  download-consul:
    cmds:
      - task: download-pkg
        vars: {
          SRC: "https://releases.hashicorp.com/consul/${CONSUL_VERSION}/consul_${CONSUL_VERSION}_linux_amd64.zip",
          DST: "http/tools/consul_${CONSUL_VERSION}_linux_amd64.zip"
        }      
  download-vault:
    cmds:
      - task: download-pkg
        vars: {
          SRC: "https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip",
          DST: "http/tools/vault_${VAULT_VERSION}_linux_amd64.zip"
        }      
  download-gotask:
    cmds:
      - task: download-pkg
        vars: {
          SRC: "https://github.com/go-task/task/releases/download/${TASK_VERSION}/task_linux_amd64.tar.gz",
          DST: "http/tools/task_linux_amd64_${TASK_VERSION}.tar.gz"
        }
  download-pkg:
    cmds:
      - echo "Downloading - {{ (splitList "/" .DST | last | quote) }}"
      - curl -sSL -o {{ .DST }} {{ .SRC }}
    silent: true
    status:
      - test -f {{ .DST }}
  make-dir:
    cmds:
      - mkdir -v -p {{ .DIR }}
    silent: true
    status:
      - test -d {{ .DIR }}
